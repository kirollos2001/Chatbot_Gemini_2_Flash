OPENAI_API_KEY = "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"
@app.route("/chat", methods=["POST"])
def chat():
    data = request.json
    thread_id = data.get("thread_id")
    user_message = f"Current Date: {datetime.datetime.now().strftime('%B %d, %Y')}\n" + data.get('message', '')

    if not user_message:
        return jsonify({"error": "Message is required"}), 400

    # âœ… Ø£ÙˆÙ„ Ù…Ø±Ø©: Ù…ÙÙŠØ´ thread_id â†’ Ù„Ø§Ø²Ù… client_info
    if not thread_id:
        client_info = data.get("client_info")
        if not client_info or not client_info.get("user_id"):
            return jsonify({"error": "Client info is missing or incomplete"}), 400

        # Ø¥Ù†Ø´Ø§Ø¡ thread Ø¬Ø¯ÙŠØ¯
        thread = client.beta.threads.create()
        thread_id = thread.id
        logging.info(f"ğŸ§µ New thread created: {thread_id}")
        save_session(thread_id, client_info)

    else:
        # âœ… Ø¨Ø¹Ø¯ ÙƒØ¯Ù‡: Ù†Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©
        client_info = get_session(thread_id)
        if not client_info:
            return jsonify({"error": "Session expired or client info missing for this thread_id"}), 400

    user_id = client_info["user_id"]

    # âœ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    extracted_info = functions.extract_client_preferences(user_message)

    # âœ… Ø¥Ù†Ø´Ø§Ø¡ / ØªØ­Ø¯ÙŠØ« lead
    lead_data = {
        "user_id": user_id,
        "name": client_info.get("name", ""),
        "phone": client_info.get("phone", ""),
        "email": client_info.get("email", ""),
        **extracted_info
    }
    functions.create_lead(lead_data)

    # âœ… ØªØ³Ø¬ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    functions.log_conversation_to_db(thread_id, user_id, user_message)

    # âœ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯
    client.beta.threads.messages.create(
        thread_id=thread_id,
        role="user",
        content=user_message
    )

    # âœ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯
    run = client.beta.threads.runs.create(
        thread_id=thread_id,
        assistant_id=assistant_id
    )

    # âœ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø£Ø¯ÙˆØ§Øª
    core_functions.process_tool_calls(client, thread_id, run.id)

    # âœ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø¯
    messages = client.beta.threads.messages.list(thread_id=thread_id)
    last_message = messages.data[0].content[0].text.value if messages.data else "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø¯ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯."

    # âœ… ØªØ³Ø¬ÙŠÙ„ Ø±Ø¯ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯
    functions.log_conversation_to_db(thread_id, "bot", last_message)

    return jsonify({"response": last_message, "thread_id": thread_id})